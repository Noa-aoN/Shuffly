<% f = local_assigns.fetch(:f, nil) %>
<% button_text = local_assigns.fetch(:button_text, '') %>
<% path = local_assigns.fetch(:path, '#') %>
<% variant = local_assigns.fetch(:variant, 'primary') %>
<% size = local_assigns.fetch(:size, 'md') %>
<% full_mobile = local_assigns.fetch(:full_mobile, true) %>
<% disabled = local_assigns.fetch(:disabled, false) %>
<% extra_class = local_assigns.fetch(:extra_class, '') %>
<% id = local_assigns.key?(:id) ? local_assigns[:id] : nil %>
<% data_action = local_assigns.key?(:data_action) ? local_assigns[:data_action] : nil %>
<% button_to_method = local_assigns.key?(:button_to_method) ? local_assigns[:button_to_method] : nil %>
<% confirm_message = local_assigns.key?(:confirm_message) ? local_assigns[:confirm_message] : nil %>
<% is_button = local_assigns.key?(:is_button) ? local_assigns[:is_button] : nil %>
<% data = local_assigns.fetch(:data, {}) %>

<%# 新規オプション: icon (asset パス or URL), icon_class, icon_alt, 既に構築済みの icon_html があれば優先する %>
<% icon_html = local_assigns.fetch(:icon_html, nil) %>
<% icon = local_assigns.fetch(:icon, nil) %>
<%# アイコンとテキストの間は全角スペース1つで制御する %>
<% icon_class = local_assigns.fetch(:icon_class, 'inline-block align-middle') %>
<% icon_alt = local_assigns.fetch(:icon_alt, '') %>

<% base = "inline-flex items-center justify-center rounded-xl font-bold focus:outline-none focus:ring-2 focus:ring-offset-2 transition shadow-lg sm:min-w-[230px] lg:min-w-[310px] px-6 py-3" %>

<% size_classes = {
  'sm' => 'px-3 py-1 text-sm min-h-[40px]',
  'md' => 'px-4 py-2 text-sm min-h-[44px]',
  'lg' => 'px-5 py-3 text-base min-h-[48px]'
} %>

<% variant_classes = {
  'primary' => 'bg-blue-500 text-white hover:bg-blue-600 focus:ring-blue-500 border border-slate-200',
  'secondary' => 'bg-white text-blue-700 hover:bg-blue-50 focus:ring-blue-200 border border-slate-200',
  'tertiary' => 'bg-white text-gray-800 hover:bg-gray-200 focus:ring-gray-400 border border-slate-200',
  'danger' => 'bg-red-500 text-white hover:bg-red-600 focus:ring-red-500 border border-slate-200'
} %>

<% size_class = size_classes[size] || size_classes['md'] %>
<% var_class = variant_classes[variant] || variant_classes['primary'] %>
<% responsive_class = full_mobile ? 'w-full sm:w-auto' : 'inline-block' %>
<% web_text_adjust = 'md:text-[16px]' %>
<% classes = [base, size_class, var_class, responsive_class, web_text_adjust, extra_class].join(' ').squeeze(' ').strip %>

<%# icon_html が未指定かつ icon が渡されている場合に生成する。
    アイコンの色はボタンの文字色に合わせるため mask(-image) を使い background-color:currentColor を適用する。
    これにより white/black/blue 等の文字色に合わせてアイコンが着色される（モダンブラウザで動作）。 %>
<% if icon_html.blank? && icon.present? %>
  <% src = (begin; asset_path(icon) rescue icon; end) %>
  <% mask_style = "background-color: currentColor; width:20px; height:20px; display:inline-block; -webkit-mask: url('#{src}') no-repeat center; -webkit-mask-size: contain; mask: url('#{src}') no-repeat center; mask-size: contain;" %>
  <%# alt は span の title 属性に使用（img の alt 相当） %>
  <% icon_html = content_tag(:span, '', class: icon_class, style: mask_style, title: (icon_alt.present? ? icon_alt : '')) %>
<% end %>

<%# 新規: icon_class に 'icon_right' が含まれる場合はアイコンを右側に配置する %>
<% icon_right = icon_class.to_s.split(/\s+/).include?('icon_right') %>

<div class="mt-2">
  <% if is_button %>
    <%# JavaScript用のボタン: type="button" %>
    <% button_opts = {
      class: classes,
      type: 'button',
      id: id,
      disabled: disabled,
      data: data.merge(data_action.present? ? { action: data_action } : {})
    } %>
    <% button_opts.delete_if { |_, v| v.nil? || v == {} } %>
    <%# アイコンがある場合はアイコンとテキストの間に全角スペースを1つ挿入する %>
    <% separator = icon_html.present? ? "　" : '' %>
    <% if icon_html.present? && icon_right %>
      <% inner = (content_tag(:span, button_text, class: 'font-semibold') + separator + icon_html.to_s).html_safe %>
    <% else %>
      <% inner = (icon_html.to_s + separator + content_tag(:span, button_text, class: 'font-semibold')).html_safe %>
    <% end %>
    <%= content_tag(:button, inner, button_opts) %>
  <% elsif f %>
    <% opts = { class: classes, id: id, disabled: disabled } %>
    <% if data_action.present? %>
      <% opts[:data] = { action: data_action } %>
    <% end %>
    <% opts.delete_if { |_, v| v.nil? } %>
    <%= f.submit button_text, opts %>
  <% elsif button_to_method.present? %>
    <%# button_to for non-GET requests (delete, post, etc.) %>
    <% button_opts = { class: classes, method: button_to_method, id: id } %>
    <% button_opts[:data] = { turbo: false } %>
    <% if confirm_message.present? %>
      <% button_opts[:data][:confirm] = confirm_message %>
    <% end %>
    <% button_opts.delete_if { |_, v| v.nil? || v == {} } %>
    <%# ブロック形式でiconを含むHTMLを渡す %>
    <%= button_to path, button_opts do %>
      <% separator = icon_html.present? ? "　" : '' %>
      <% if icon_html.present? && icon_right %>
        <%= raw(content_tag(:span, button_text, class: 'font-semibold') + separator + icon_html.to_s) %>
      <% else %>
        <%= raw(icon_html.to_s + separator + content_tag(:span, button_text, class: 'font-semibold')) %>
      <% end %>
    <% end %>
  <% else %>
    <% link_opts = { class: classes, role: 'button', id: id, 'aria-disabled' => disabled ? 'true' : nil } %>
    <% if data_action.present? %>
      <% link_opts[:data] = { action: data_action } %>
    <% end %>
    <% link_opts.delete_if { |_, v| v.nil? } %>
    <%# アイコンがある場合はアイコンとテキストの間に全角スペースを1つ挿入する %>
    <% separator = icon_html.present? ? "　" : '' %>
    <% if icon_html.present? && icon_right %>
      <% inner = (content_tag(:span, button_text, class: 'font-semibold') + separator + icon_html.to_s).html_safe %>
    <% else %>
      <% inner = (icon_html.to_s + separator + content_tag(:span, button_text, class: 'font-semibold')).html_safe %>
    <% end %>
    <%= link_to raw(inner), path, link_opts %>
  <% end %>
</div>