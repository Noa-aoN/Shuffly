<%# イベント詳細ページ %>

<div class="max-w-6xl mx-auto px-6 py-6 md:py-8">
  <%# ヘッダー: タイトルとメタデータ %>
  <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex-1">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
        <span class="event-title cursor-pointer hover:bg-gray-100 rounded px-2 py-1 -mx-2 transition-colors"
              data-event-id="<%= @event.id %>"
              data-event-title="<%= @event.title.presence || t("mypage.events.title") %>">
          <%= @event.title.presence || t("mypage.events.title") %>
        </span>
        <span class="text-sm text-gray-400 ml-2">
          <%= image_tag 'icons/edit_note_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
                         width: 16,
                         height: 16,
                         class: 'inline-block align-middle opacity-50',
                         alt: '編集' %>
        </span>
      </h1>
      <div class="flex flex-wrap gap-4 text-base text-gray-600">
        <span class="flex items-center gap-1">
          <%= image_tag 'icons/today_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg', width: 20, height: 20, alt: "作成日アイコン" %>
          <%= t("mypage.event_detail.created_at") %>: <%= @event.created_at.strftime('%Y/%m/%d %H:%M') %>
        </span>
        <span class="flex items-center gap-1">
          <%= image_tag 'icons/schedule_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg', width: 20, height: 20, alt: "更新日アイコン" %>
          <%= t("mypage.event_detail.updated_at") %>: <%= @event.updated_at.strftime('%Y/%m/%d %H:%M') %>
        </span>
        <span class="flex items-center gap-1">
          <%= image_tag 'icons/groups_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg', width: 20, height: 20, alt: "人数アイコン" %>
          <%= t("mypage.event_detail.members_count", count: @members.count) %>
        </span>
      </div>
      <%# 実行回数表示 %>
      <div class="flex flex-wrap gap-4 text-sm text-gray-500 mt-2" id="execution-counts">
        <span>グループ分け回数: <strong id="groups-count">0回</strong></span>
        <span>順番決め回数: <strong id="order-count">0回</strong></span>
        <span>役割分担回数: <strong id="roles-count">0回</strong></span>
      </div>
    </div>

    <%# アクションボタン %>
    <div class="mt-4 pt-4 border-t border-gray-100">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2 w-full sm:place-items-center">
        <%= render 'shared/button',
              button_text: t("mypage.event_detail.back"),
              path: mypage_path(tab: 'events'),
              variant: 'tertiary',
              size: 'sm',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_return_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
        <%= render 'shared/button',
              button_text: '続きからシャッフル',
              path: new_event_path(load_event_id: @event.id),
              variant: 'primary',
              size: 'sm',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/start_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
        <%= render 'shared/button',
              button_text: 'イベント履歴を削除',
              path: event_path(@event),
              variant: 'tertiary',
              size: 'sm',
              full_mobile: true,
              button_to_method: :delete,
              id: 'btn-delete-event',
              extra_class: 'w-full bg-red-50 text-red-600 hover:bg-red-100',
              icon: 'icons/delete_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>
    </div>
  </div>

  <%# タブナビゲーション（results_panelと同じスタイル） %>
  <div class="mb-6">
    <div class="inline-flex w-full items-center gap-2 bg-white rounded-xl p-1 border border-slate-200 shadow-sm">
      <button id="tab-groups" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm md:text-lg font-semibold text-blue-600 bg-blue-50 ring-1 ring-blue-100 shadow-sm">
        <%= image_tag "icons/diversity_3_24dp_1F1F1F.svg", width: 24, height: 24, class: "inline-block relative bottom-0.5", alt: "グループアイコン" %>
        <span class="hidden sm:inline leading-none">グループ</span>
      </button>
      <button id="tab-order" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm md:text-lg font-semibold text-gray-600 hover:text-blue-500">
        <%= image_tag "icons/format_list_numbered_24dp_1F1F1F.svg", width: 24, height: 24, class: "inline-block relative bottom-0.5", alt: "順番アイコン" %>
        <span class="hidden sm:inline leading-none">順番</span>
      </button>
      <button id="tab-roles" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm md:text-lg font-semibold text-gray-600 hover:text-blue-500">
        <%= image_tag "icons/badge_24dp_1F1F1F.svg", width: 24, height: 24, class: "inline-block relative bottom-0.5", alt: "役割アイコン" %>
        <span class="hidden sm:inline leading-none">役割</span>
      </button>
    </div>
  </div>

  <%# グループパネル %>
  <div id="panel-groups" class="bg-gray-100 rounded-xl shadow-sm px-6 md:px-10 py-8">
    <h3 class="mb-2 font-semibold text-gray-600"><span class="text-sm text-blue-500">●</span> グループ表示</h3>
    <div id="pres-groups" class="whitespace-pre-wrap text-lg text-gray-800 bg-yellow-100 border border-slate-300 rounded-xl px-3 py-2 w-full mb-4 min-h-[480px] max-h-[480px] overflow-y-auto"></div>

    <%# 履歴インデックス %>
    <div class="text-base text-yellow-800 mt-1 mb-4 bg-yellow-100 border-2 border-dashed border-yellow-200 rounded-xl px-4 py-2">
      現在のグループ分け表示：<span id="history-index-groups" class="font-bold">未実施</span>
    </div>

    <%# 結果操作ボタン（tertiary） %>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2 w-full sm:place-items-center">
      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">前回のグループ分け</span><span class="inline sm:hidden">前回</span>'),
              id: 'btn-prev-groups',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_left_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>

      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">次回のグループ分け</span><span class="inline sm:hidden">次回</span>'),
              id: 'btn-next-groups',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_right_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block icon_right' %>
      </div>

      <div class="col-span-2 md:col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: 'クリップボードにコピー',
              id: 'btn-copy-groups',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/content_copy_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>
    </div>
  </div>

  <%# 順番パネル %>
  <div id="panel-order" class="bg-gray-100 rounded-xl shadow-sm px-6 md:px-10 py-8 hidden">
    <h3 class="font-semibold mb-2 text-gray-600"><span class="text-sm text-blue-500">●</span> 順番表示</h3>
    <div id="pres-order" class="whitespace-pre-wrap text-lg text-gray-800 bg-yellow-100 border border-slate-300 rounded-xl px-3 py-2 w-full mb-4 min-h-[480px] max-h-[480px] overflow-y-auto"></div>

    <%# 履歴インデックス %>
    <div class="text-base text-yellow-800 mt-1 mb-4 bg-yellow-100 border-2 border-dashed border-yellow-200 rounded-xl px-4 py-2">
      現在の順番決め表示：<span id="history-index-order" class="font-bold">未実施</span>
    </div>

    <%# 結果操作ボタン（tertiary） %>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2 w-full sm:place-items-center">
      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">前回の順番決め</span><span class="inline sm:hidden">前回</span>'),
              id: 'btn-prev-order',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_left_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>

      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">次回の順番決め</span><span class="inline sm:hidden">次回</span>'),
              id: 'btn-next-order',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_right_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block icon_right' %>
      </div>

      <div class="col-span-2 md:col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: 'クリップボードにコピー',
              id: 'btn-copy-order',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/content_copy_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>
    </div>
  </div>

  <%# 役割パネル %>
  <div id="panel-roles" class="bg-gray-100 rounded-xl shadow-sm px-6 md:px-10 py-8 hidden">
    <h3 class="font-semibold mb-2 text-gray-600"><span class="text-sm text-blue-500">●</span> 役割表示</h3>
    <div id="pres-roles" class="whitespace-pre-wrap text-lg text-gray-800 bg-yellow-100 border border-slate-300 rounded-xl px-3 py-2 w-full mb-4 min-h-[480px] max-h-[480px] overflow-y-auto"></div>

    <%# 履歴インデックス %>
    <div class="text-base text-yellow-800 mt-1 mb-4 bg-yellow-100 border-2 border-dashed border-yellow-200 rounded-xl px-4 py-2">
      現在の役割分担表示：<span id="history-index-roles" class="font-bold">未実施</span>
    </div>

    <%# 結果操作ボタン（tertiary） %>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2 w-full sm:place-items-center">
      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">前回の役割分担</span><span class="inline sm:hidden">前回</span>'),
              id: 'btn-prev-roles',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_left_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>

      <div class="col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: raw('<span class="hidden sm:inline">次回の役割分担</span><span class="inline sm:hidden">次回</span>'),
              id: 'btn-next-roles',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/keyboard_double_arrow_right_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block icon_right' %>
      </div>

      <div class="col-span-2 md:col-span-1">
        <%= render 'shared/button',
              f: nil,
              button_text: 'クリップボードにコピー',
              id: 'btn-copy-roles',
              path: '#',
              variant: 'tertiary',
              full_mobile: true,
              extra_class: 'w-full',
              icon: 'icons/content_copy_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
              icon_class: 'inline-block' %>
      </div>
    </div>
  </div>

  <%# メモカード %>
  <div class="bg-gray-100 rounded-xl shadow-sm px-6 md:px-10 py-8 mt-6">
    <h2 class="text-xl font-bold mb-4"><%= t("mypage.event_detail.memo") %></h2>
    <%= form_with model: @event, url: event_path(@event), method: :patch, id: 'memo-form', local: true, data: { turbo: false } do |f| %>
      <%= f.text_area :memo,
            rows: 3,
            class: "w-full border border-slate-300 rounded-xl px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition bg-white",
            placeholder: t("mypage.event_detail.memo_placeholder") %>
      <div class="mt-3">
        <div class="grid grid-cols-1 sm:grid-cols-1 gap-2 mb-2 w-full sm:place-items-center">
          <%= render 'shared/button',
                f: f,
                button_text: t("mypage.event_detail.save_memo"),
                variant: 'tertiary',
                full_mobile: true,
                extra_class: 'w-full',
                icon: 'icons/edit_note_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
                icon_class: 'inline-block' %>
        </div>
      </div>
    <% end %>
  </div>

  <%# エクスポートセクション %>
  <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
    <h2 class="text-xl font-bold mb-4"><%= t("mypage.event_detail.export") %></h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2 w-full sm:place-items-center">
      <%= render 'shared/button',
            button_text: 'プレゼン表示',
            path: '#',
            id: 'btn-presentation',
            variant: 'tertiary',
            full_mobile: true,
            extra_class: 'w-full',
            icon: 'icons/share_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
            icon_class: 'inline-block' %>
      <%= render 'shared/button',
            button_text: "ファイル出力",
            path: '#',
            id: 'btn-export-current',
            variant: 'tertiary',
            full_mobile: true,
            extra_class: 'w-full',
            icon: 'icons/download_2_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
            icon_class: 'inline-block' %>
      <%= render 'shared/button',
            button_text: "ファイル全履歴出力",
            path: '#',
            id: 'btn-export-all-history',
            variant: 'tertiary',
            full_mobile: true,
            extra_class: 'w-full',
            icon: 'icons/download_2_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg',
            icon_class: 'inline-block' %>
    </div>
  </div>
</div>

<%# サーバーデータをdata属性に設定 %>
<div id="events-show-data"
     data-members="<%= raw @members.to_json %>"
     data-results="<%= raw @results.to_json %>"
     data-order="<%= raw @order.to_json %>"
     data-settings="<%= raw @settings.to_json %>"
     data-history="<%= raw @history.to_json %>"
     data-title="<%= raw @event.title.to_json %>"
     data-presentation-path="<%= presentation_events_path %>"
     data-event-path="<%= event_path(@event) %>"
     data-delete-confirm="<%= raw t("mypage.event_detail.delete_confirm_event").to_json %>"
     data-copied="<%= raw t("mypage.event_detail.copied").to_json %>"
     data-copy-failed="<%= raw t("mypage.event_detail.copy_failed").to_json %>"
     data-no-data="<%= raw t("mypage.event_detail.no_data").to_json %>"
     class="hidden">
</div>

<%# タブ切替用データ属性 %>
<% content_for :javascript do %>
<script>
(function(){
  // Server-provided data (正規化形式のみ)
  const serverData = {
    title: <%= raw @event.title.to_json %>,
    data_version: <%= @data_version || 2 %>,
    members: <%= raw @members.to_json %>,
    group_rounds: <%= raw @group_rounds.to_json %>,
    order_rounds: <%= raw @order_rounds.to_json %>,
    role_rounds: <%= raw @role_rounds.to_json %>,
    co_occurrence: <%= raw @co_occurrence.to_json %>
  };

  // History state for each tab
  const historyState = {
    groups: { index: -1, history: [] },
    order: { index: -1, history: [] },
    roles: { index: -1, history: [] }
  };

  // Actual execution counts (全体統計と同じカウント方法で計算された実際の回数)
  const actualCounts = {
    groups: 0,
    order: 0,
    roles: 0
  };

  // Parse history (正規化形式のみ)
  function parseHistoryByType() {
    // 正規化形式のroundsデータを直接使用
    if (serverData.group_rounds && Array.isArray(serverData.group_rounds)) {
      serverData.group_rounds.forEach(round => {
        // typeフィールドを追加して、後の処理で認識できるようにする
        historyState.groups.history.push({ ...round, type: 'groups', data: round });
      });
    }
    if (serverData.order_rounds && Array.isArray(serverData.order_rounds)) {
      serverData.order_rounds.forEach(round => {
        historyState.order.history.push({ ...round, type: 'order', data: round });
      });
    }
    if (serverData.role_rounds && Array.isArray(serverData.role_rounds)) {
      serverData.role_rounds.forEach(round => {
        historyState.roles.history.push({ ...round, type: 'roles', data: round });
      });
    }

    // 実行回数を更新
    actualCounts.groups = historyState.groups.history.length;
    actualCounts.order = historyState.order.history.length;
    actualCounts.roles = historyState.roles.history.length;
  }
  parseHistoryByType();

  // Set initial indices to last (最新の履歴を最初に表示 - events_new.jsと統一)
  historyState.groups.index = historyState.groups.history.length > 0 ? historyState.groups.history.length - 1 : -1;
  historyState.order.index = historyState.order.history.length > 0 ? historyState.order.history.length - 1 : -1;
  historyState.roles.index = historyState.roles.history.length > 0 ? historyState.roles.history.length - 1 : -1;

  // Tab switching
  const tabs = document.querySelectorAll('#tab-groups, #tab-order, #tab-roles');
  const panels = {
    groups: document.getElementById('panel-groups'),
    order: document.getElementById('panel-order'),
    roles: document.getElementById('panel-roles')
  };

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetId = this.id.replace('tab-', '');
      const targetPanel = panels[targetId];

      // Update tab styles
      tabs.forEach(t => {
        t.classList.remove('text-blue-600', 'bg-blue-50', 'ring-1', 'ring-blue-100', 'shadow-sm');
        t.classList.add('text-gray-600');
      });
      this.classList.remove('text-gray-600');
      this.classList.add('text-blue-600', 'bg-blue-50', 'ring-1', 'ring-blue-100', 'shadow-sm');

      // Show target panel
      Object.values(panels).forEach(p => p.classList.add('hidden'));
      targetPanel.classList.remove('hidden');
    });
  });

  // Utility function for safe JSON parsing
  function safeParse(str) {
    try {
      return JSON.parse(str);
    } catch (e) {
      return null;
    }
  }

  // Rendering functions
  function renderGroups(results){
    const el = document.getElementById('pres-groups');
    if(!results || !results.groups){ el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>; return; }
    const groups = results.groups;
    const groupNames = results.group_names || results.groupNames || {};
    let out = '';
    Object.keys(groups).forEach(k=>{
      const members = groups[k] || [];
      const label = groupNames[k] || k;
      out += label + ' (' + members.length + '名):\n';
      members.forEach(m=>{
        if(typeof m === 'string') {
          // 文字列の場合：そのまま表示（空文字列はスキップ）
          if(m.trim()) out += '  - ' + m + '\n';
        } else if(m && (m.name || m.full_name)) {
          // オブジェクトの場合：名前と役割を表示
          out += '  - ' + (m.name || m.full_name) + (m.role ? (' — ' + m.role) : '') + '\n';
        }
        // それ以外（無効なデータ）はスキップして表示しない
      });
      out += '\n';
    });
    el.textContent = out.trim();
  }

  function renderOrder(orderData){
    const el = document.getElementById('pres-order');
    if(!orderData || Object.keys(orderData).length === 0){ el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>; return; }
    const ord = Array.isArray(orderData) ? orderData : (typeof orderData === 'string' ? safeParse(orderData) : orderData);
    if(!ord || ord.length === 0){ el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>; return; }

    const lines = ord.map((o, i) => {
      let name;

      // オブジェクトの場合
      if (typeof o === 'object' && o !== null) {
        name = o.name;
        // nameがない場合はmember_idから検索
        if (!name && o.member_id && serverData.members) {
          const member = serverData.members.find(m => m.id === o.member_id);
          name = member ? member.name : `メンバー${o.member_id}`;
        }
      }
      // 文字列の場合
      else if (typeof o === 'string') {
        name = o;
      }
      // 数字の場合（member_idとして扱う）
      else if (typeof o === 'number') {
        if (serverData.members) {
          const member = serverData.members.find(m => m.id === o);
          name = member ? member.name : `メンバー${o}`;
        } else {
          name = `メンバー${o}`;
        }
      }

      const orderNum = (o && typeof o === 'object' && (o.order || o.order_index)) || (i + 1);
      return `${orderNum}. ${name || '不明'}`;
    });

    el.textContent = lines.join('\n');
  }

  function renderRoles(settings){
    const el = document.getElementById('pres-roles');
    if(!settings || Object.keys(settings).length === 0){ el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>; return; }
    try{
      const s = (typeof settings === 'string') ? safeParse(settings) : settings;
      if(s && s.role_assignments && Array.isArray(s.role_assignments)){
        // roleがnullまたは空のメンバーは表示しない
        const filtered = s.role_assignments.filter(r => r.role && r.role.trim() !== '');
        if (filtered.length === 0) {
          el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>;
        } else {
          el.textContent = filtered.map(r => {
            let name = r.name;
            // nameがない場合はmember_idから検索
            if (!name && r.member_id && serverData.members) {
              const member = serverData.members.find(m => m.id === r.member_id);
              name = member ? member.name : `メンバー${r.member_id}`;
            }
            return `${name || '不明'}: ${r.role}`;
          }).join('\n');
        }
      } else if(s && s.roles && typeof s.roles === 'string'){
        el.textContent = '役職: ' + s.roles;
      } else el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>;
    }catch(e){ el.textContent = <%= raw t("mypage.event_detail.no_data").to_json %>; }
  }

  // Update history index display
  function updateHistoryIndex(tab) {
    const state = historyState[tab];
    const idxEl = document.getElementById('history-index-' + tab);
    const prevBtn = document.getElementById('btn-prev-' + tab);
    const nextBtn = document.getElementById('btn-next-' + tab);

    // 履歴エントリー数を取得（重複除外なしの全履歴数）
    const totalCount = state.history.length;

    if (totalCount === 0) {
      idxEl.textContent = '未実施';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
    } else {
      // 現在のインデックス（0始まり）を1始まりの回数に変換
      const currentRound = state.index + 1;
      idxEl.textContent = `${currentRound}/${totalCount}回目`;
      prevBtn.disabled = (state.index <= 0);
      nextBtn.disabled = (state.index >= totalCount - 1);
    }
  }

  // Navigate history
  function navigateHistory(tab, direction) {
    const state = historyState[tab];
    const newIndex = state.index + direction;

    if (newIndex >= 0 && newIndex < state.history.length) {
      state.index = newIndex;
      const entry = state.history[newIndex];

      // 新形式: { type: 'groups'|'order'|'roles', data: {...} }
      // 旧形式: { groups: {...} } など
      let dataToRender = null;
      if (entry.type) {
        // 新形式
        dataToRender = entry.data;
      } else {
        // 旧形式
        dataToRender = entry;
      }

      if (tab === 'groups') {
        const groupsData = dataToRender.groups || dataToRender;

        // assignments形式の場合
        if (dataToRender.assignments && Array.isArray(dataToRender.assignments)) {
          // assignments形式をgroups形式に変換
          const groups = {};
          dataToRender.assignments.forEach(assignment => {
            const groupId = assignment.group_id || assignment.group_name;
            groups[groupId] = assignment.members.map(m => m.name);
          });
          renderGroups({ groups: groups });
        }
        // groups形式の場合
        else if (groupsData && typeof groupsData === 'object' && !groupsData.membersRaw) {
          renderGroups(dataToRender);
        }
        // membersRaw形式の場合
        else if (groupsData && groupsData.membersRaw) {
          // membersRawから履歴をパースしてグループを再構築
          const raw = groupsData.membersRaw;
          const rawList = raw ? raw.split(/[\r\n,]+/).map(s=>s.trim()).filter(Boolean) : [];
          const entries = rawList.map(line => {
            const name = line.split('#')[0].trim();
            const hist = line.match(/#\d+[A-Z]/g) || [];
            return { name, history: hist };
          });

          // グループを再構築
          const groups = {};
          entries.forEach(e => {
            const last = e.history.at(-1);
            const m = last ? last.match(/#\d+([A-Z])$/) : null;
            const groupId = m ? m[1] : null;
            if (groupId) {
              if (!groups[groupId]) groups[groupId] = [];
              groups[groupId].push(e.name);
            }
          });

          if (Object.keys(groups).length > 0) {
            renderGroups({ groups: groups });
          }
        }
        // タブを切り替え
        switchTab('groups');
      }

      if (tab === 'order') {
        // 新形式: data.result、旧形式: order
        const orderArray = dataToRender.result || dataToRender.order || dataToRender;
        if (orderArray && Array.isArray(orderArray)) {
          renderOrder(orderArray);
        }
        // タブを切り替え
        switchTab('order');
      }

      if (tab === 'roles') {
        // 新形式: data.assignments、旧形式: settings
        if (dataToRender.assignments) {
          // assignments形式をrole_assignments形式に変換
          renderRoles({ role_assignments: dataToRender.assignments });
        } else if (dataToRender.settings) {
          renderRoles(dataToRender.settings);
        } else {
          // dataToRender自体がrole_assignmentsを持っている場合
          renderRoles(dataToRender);
        }
        // タブを切り替え
        switchTab('roles');
      }

      updateHistoryIndex(tab);
    }
  }

  // Setup navigation buttons
  ['groups', 'order', 'roles'].forEach(tab => {
    const prevBtn = document.getElementById('btn-prev-' + tab);
    const nextBtn = document.getElementById('btn-next-' + tab);

    if (prevBtn) {
      prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        navigateHistory(tab, -1);
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        navigateHistory(tab, 1);
      });
    }
  });

  // Setup tab switching
  function switchTab(tabName) {
    // Hide all panels
    document.querySelectorAll('[id^="panel-"]').forEach(panel => {
      panel.classList.add('hidden');
    });

    // Show selected panel
    const selectedPanel = document.getElementById('panel-' + tabName);
    if (selectedPanel) {
      selectedPanel.classList.remove('hidden');
    }

    // Update tab styles
    const tabs = ['groups', 'order', 'roles'];
    tabs.forEach(tab => {
      const tabEl = document.getElementById('tab-' + tab);
      if (tabEl) {
        if (tab === tabName) {
          // Active tab styles
          tabEl.classList.remove('text-gray-600', 'hover:text-blue-500');
          tabEl.classList.add('text-blue-600', 'bg-blue-50', 'ring-1', 'ring-blue-100', 'shadow-sm');
        } else {
          // Inactive tab styles
          tabEl.classList.remove('text-blue-600', 'bg-blue-50', 'ring-1', 'ring-blue-100', 'shadow-sm');
          tabEl.classList.add('text-gray-600', 'hover:text-blue-500');
        }
      }
    });

    // Update navigation buttons for the current tab
    updateHistoryIndex(tabName);
  }

  // Add click event listeners to tabs
  document.getElementById('tab-groups').addEventListener('click', () => switchTab('groups'));
  document.getElementById('tab-order').addEventListener('click', () => switchTab('order'));
  document.getElementById('tab-roles').addEventListener('click', () => switchTab('roles'));

  // Initial render - 履歴がある場合は最新の履歴データを表示（events_new.jsと統一）
  // グループ: 履歴ベースでのみ表示（履歴がない場合は何も表示しない）
  if (historyState.groups.history.length > 0) {
    const latestGroups = historyState.groups.history[historyState.groups.history.length - 1];
    const groupsData = latestGroups.type === 'groups' ? latestGroups.data : latestGroups;

    // assignments形式の場合
    if (latestGroups.assignments && Array.isArray(latestGroups.assignments)) {
      const groups = {};
      latestGroups.assignments.forEach(assignment => {
        const groupId = assignment.group_id || assignment.group_name;
        groups[groupId] = assignment.members.map(m => m.name);
      });
      renderGroups({ groups: groups });
    }
    // groups形式の場合
    else if (groupsData && groupsData.groups && typeof groupsData.groups === 'object') {
      renderGroups(groupsData);
    }
    // membersRaw形式の場合
    else if (groupsData && groupsData.membersRaw) {
      // membersRaw形式の場合はグループを再構築
      const raw = groupsData.membersRaw;
      const rawList = raw ? raw.split(/[\r\n,]+/).map(s=>s.trim()).filter(Boolean) : [];
      const entries = rawList.map(line => {
        const name = line.split('#')[0].trim();
        const hist = line.match(/#\d+[A-Z]/g) || [];
        return { name, history: hist };
      });
      // グループを再構築
      const groups = {};
      entries.forEach(e => {
        const last = e.history.at(-1);
        const m = last ? last.match(/#\d+([A-Z])$/) : null;
        const groupId = m ? m[1] : null;
        if (groupId) {
          if (!groups[groupId]) groups[groupId] = [];
          groups[groupId].push(e.name);
        }
      });
      if (Object.keys(groups).length > 0) {
        renderGroups({ groups: groups });
      }
    }
  }
  // 履歴がない場合は何も表示しない（空白のまま）

  // 順番: 履歴ベースでのみ表示（最新を表示）
  if (historyState.order.history.length > 0) {
    const latestOrder = historyState.order.history[historyState.order.history.length - 1];
    const orderData = latestOrder.type === 'order' ? latestOrder.data : latestOrder;
    const orderArray = orderData ? (orderData.result || orderData.order || orderData) : null;
    if (orderArray && Array.isArray(orderArray)) {
      renderOrder(orderArray);
    }
  }
  // 履歴がない場合は何も表示しない

  // 役割: 履歴ベースでのみ表示（最新を表示）
  if (historyState.roles.history.length > 0) {
    const latestRoles = historyState.roles.history[historyState.roles.history.length - 1];
    const rolesData = latestRoles.type === 'roles' ? latestRoles.data : latestRoles;
    const rolesSettings = rolesData ? (rolesData.assignments || rolesData.settings || rolesData) : null;
    if (rolesSettings) {
      // assignments形式をsettings形式に変換
      if (rolesData.assignments) {
        renderRoles({ role_assignments: rolesData.assignments });
      } else {
        renderRoles(rolesSettings);
      }
    }
  }
  // 履歴がない場合は何も表示しない

  // Initialize navigation buttons and set initial tab
  ['groups', 'order', 'roles'].forEach(tab => {
    updateHistoryIndex(tab);
  });

  // Determine initial tab based on latest history entry
  let initialTab = 'groups';
  if (historyState.roles.history.length > 0) {
    initialTab = 'roles';
  } else if (historyState.order.history.length > 0) {
    initialTab = 'order';
  } else if (historyState.groups.history.length > 0) {
    initialTab = 'groups';
  }

  // Switch to initial tab
  switchTab(initialTab);

  // Parse entry to extract name and history (同じロジックをevents_new.jsから移植)
  function parseEntry(entry) {
    const name = entry.split('#')[0].trim();
    const hist = entry.match(/#\d+[A-Z]/g) || [];
    return {name, history: hist};
  }

  // Get group round number from entries (events_new.jsと同じロジック)
  function getGroupRound(entries, nextRound = false) {
    let max = 0;
    let found = false;
    for(const e of entries) {
      for(const h of e.history) {
        const m = h.match(/^#(\d+)/);
        if(m){
          found = true;
          const num = parseInt(m[1], 10);
          if(num > max) max = num;
        }
      }
    }
    if(!found) return null;
    return nextRound ? max + 1 : max;
  }

  // Update execution counts (historyState.history.lengthを使用して全履歴数をカウント)
  function updateExecutionCounts() {
    const groupsCountEl = document.getElementById('groups-count');
    const orderCountEl = document.getElementById('order-count');
    const rolesCountEl = document.getElementById('roles-count');

    // historyStateから履歴エントリー数を取得（重複除外なしの全履歴数）
    const groupsCount = historyState.groups.history.length;
    const orderCount = historyState.order.history.length;
    const rolesCount = historyState.roles.history.length;

    if (groupsCountEl) groupsCountEl.textContent = groupsCount + '回';
    if (orderCountEl) orderCountEl.textContent = orderCount + '回';
    if (rolesCountEl) rolesCountEl.textContent = rolesCount + '回';

    // 計算した回数をグローバル変数に保存
    actualCounts.groups = groupsCount;
    actualCounts.order = orderCount;
    actualCounts.roles = rolesCount;
  }
  updateExecutionCounts();

  // Initialize history navigation (actualCountsが計算された後に実行)
  ['groups', 'order', 'roles'].forEach(tab => updateHistoryIndex(tab));

  // Copy function with toast notification
  function copyToClipboard(text, successMsg) {
    navigator.clipboard.writeText(text).then(()=> {
      showToast(successMsg);
    }).catch(()=> {
      alert(<%= raw t("mypage.event_detail.copy_failed").to_json %>);
    });
  }

  // Copy buttons for each tab
  document.getElementById('btn-copy-groups').addEventListener('click', function(e){
    e.preventDefault();
    const text = document.getElementById('pres-groups').textContent || '';
    copyToClipboard(text, <%= raw t("mypage.event_detail.copied").to_json %>);
  });

  document.getElementById('btn-copy-order').addEventListener('click', function(e){
    e.preventDefault();
    const text = document.getElementById('pres-order').textContent || '';
    copyToClipboard(text, <%= raw t("mypage.event_detail.copied").to_json %>);
  });

  document.getElementById('btn-copy-roles').addEventListener('click', function(e){
    e.preventDefault();
    const text = document.getElementById('pres-roles').textContent || '';
    copyToClipboard(text, <%= raw t("mypage.event_detail.copied").to_json %>);
  });

  // Presentation mode
  document.getElementById('btn-presentation').addEventListener('click', function(e){
    e.preventDefault();
    try{
      localStorage.setItem('presentation_shuffly_event', JSON.stringify(serverData));
    }catch(e){ console.warn('presentation store failed', e); }
    const w = window.open('<%= presentation_events_path %>', '_blank', 'noopener');
    if(!w) alert('ポップアップがブロックされました。ポップアップを許可してください');
  });

  // Export functions
  function downloadText(filename, content) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('ファイルを出力しました');
  }

  // Export current display (現在表示されている内容をテキスト出力)
  document.getElementById('btn-export-current').addEventListener('click', function(e){
    e.preventDefault();

    const title = serverData.title || 'イベント結果';
    const groupsContent = document.getElementById('pres-groups').textContent.trim();
    const orderContent = document.getElementById('pres-order').textContent.trim();
    const rolesContent = document.getElementById('pres-roles').textContent.trim();

    let combinedContent = `${title}\n`;
    combinedContent += '='.repeat(50) + '\n\n';

    if (groupsContent) {
      combinedContent += '【グループ分け】\n';
      combinedContent += '-'.repeat(50) + '\n';
      combinedContent += groupsContent + '\n\n';
    }

    if (orderContent) {
      combinedContent += '【順番決め】\n';
      combinedContent += '-'.repeat(50) + '\n';
      combinedContent += orderContent + '\n\n';
    }

    if (rolesContent) {
      combinedContent += '【役割分担】\n';
      combinedContent += '-'.repeat(50) + '\n';
      combinedContent += rolesContent + '\n\n';
    }

    const filename = `${title.replace(/[\\/:*?"<>|]/g, '_')}.txt`;
    downloadText(filename, combinedContent);
  });

  // Export all history (全履歴をテキスト出力)
  document.getElementById('btn-export-all-history').addEventListener('click', function(e){
    e.preventDefault();

    const title = serverData.title || 'イベント結果';
    let combinedContent = `${title} - 全履歴\n`;
    combinedContent += '='.repeat(50) + '\n\n';

    const history = Array.isArray(serverData.history) ? serverData.history : [];
    let groupsRound = 0, orderRound = 0, rolesRound = 0;

    // グループ分け履歴を出力（新形式と旧形式に対応）
    const groupsHistory = history.filter(entry => {
      const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
      if (!parsed) return false;
      // 新形式: typeフィールドで厳密に判定
      if (parsed.type === 'groups') {
        // dataフィールドがあり、有効なデータが含まれている場合のみ
        return parsed.data && (parsed.data.groups || (parsed.data.membersRaw && parsed.data.membersRaw.trim()));
      }
      // 旧形式: groupsのみ
      return !parsed.type && parsed.groups && !parsed.order && !parsed.settings;
    });

    if (groupsHistory.length > 0) {
      combinedContent += '【グループ分け履歴】\n';
      combinedContent += '-'.repeat(50) + '\n';
      groupsHistory.forEach((entry, idx) => {
        const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
        let dataToExport = null;
        if (parsed.type === 'groups') {
          // 新形式: data内にデータがある
          dataToExport = parsed.data;
        } else if (parsed.groups) {
          // 旧形式: 直接groupsがある
          dataToExport = parsed;
        }

        if (dataToExport) {
          groupsRound++;
          combinedContent += `\n${groupsRound}回目:\n`;

          // membersRaw形式からグループを再構築
          if (dataToExport.membersRaw) {
            const raw = dataToExport.membersRaw;
            const rawList = raw ? raw.split(/[\r\n,]+/).map(s=>s.trim()).filter(Boolean) : [];
            const entries = rawList.map(line => {
              const name = line.split('#')[0].trim();
              const hist = line.match(/#\d+[A-Z]/g) || [];
              return { name, history: hist };
            });

            // グループを再構築
            const groups = {};
            entries.forEach(e => {
              const last = e.history.at(-1);
              const m = last ? last.match(/#\d+([A-Z])$/) : null;
              const groupId = m ? m[1] : null;
              if (groupId) {
                if (!groups[groupId]) groups[groupId] = [];
                groups[groupId].push(e.name);
              }
            });

            if (Object.keys(groups).length > 0) {
              Object.keys(groups).forEach(k => {
                const members = groups[k] || [];
                combinedContent += `グループ${k} (${members.length}名):\n`;
                members.forEach(m => {
                  combinedContent += `  - ${m}\n`;
                });
                combinedContent += '\n';
              });
            }
          } else if (dataToExport.groups) {
            // groupsデータが直接ある場合
            const groups = dataToExport.groups;
            const groupNames = dataToExport.group_names || dataToExport.groupNames || {};
            Object.keys(groups).forEach(k => {
              const members = groups[k] || [];
              const label = groupNames[k] || k;
              combinedContent += `${label} (${members.length}名):\n`;
              members.forEach(m => {
                if(typeof m === 'string' && m.trim()) combinedContent += `  - ${m}\n`;
                else if(m && (m.name || m.full_name)) combinedContent += `  - ${m.name || m.full_name}${m.role ? ' — ' + m.role : ''}\n`;
              });
              combinedContent += '\n';
            });
          }
        }
      });
      combinedContent += '\n';
    }

    // 順番決め履歴を出力（新形式と旧形式に対応）
    const orderHistory = history.filter(entry => {
      const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
      if (!parsed) return false;
      // 新形式: typeフィールドで厳密に判定
      if (parsed.type === 'order') {
        // dataフィールドがあり、有効なデータが含まれている場合のみ
        return parsed.data && (parsed.data.result || parsed.data.order);
      }
      // 旧形式: orderのみ
      return !parsed.type && parsed.order && !parsed.groups && !parsed.settings;
    });

    if (orderHistory.length > 0) {
      combinedContent += '【順番決め履歴】\n';
      combinedContent += '-'.repeat(50) + '\n';
      orderHistory.forEach((entry, idx) => {
        const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
        let orderData = null;
        if (parsed.type === 'order') {
          // 新形式: data内にデータがある
          orderData = parsed.data;
          if (orderData && orderData.result) {
            orderData = orderData.result;
          }
        } else if (parsed.order) {
          // 旧形式: 直接orderがある
          orderData = parsed.order;
        }

        if (orderData) {
          orderRound++;
          combinedContent += `\n${orderRound}回目:\n`;
          const ord = Array.isArray(orderData) ? orderData : (typeof orderData === 'string' ? safeParse(orderData) : orderData);
          if (ord && ord.length > 0) {
            const lines = ord.map((o, i) => `${i + 1}. ${o.name || o}`).join('\n');
            combinedContent += lines + '\n';
          }
        }
      });
      combinedContent += '\n';
    }

    // 役割分担履歴を出力（新形式と旧形式に対応）
    const rolesHistory = history.filter(entry => {
      const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
      if (!parsed) return false;
      // 新形式: typeフィールドで厳密に判定
      if (parsed.type === 'roles') {
        // dataフィールドがあり、有効なデータが含まれている場合のみ
        return parsed.data && (parsed.data.assignments || parsed.data.settings);
      }
      // 旧形式: settingsのみ
      return !parsed.type && parsed.settings && !parsed.groups && !parsed.order;
    });

    if (rolesHistory.length > 0) {
      combinedContent += '【役割分担履歴】\n';
      combinedContent += '-'.repeat(50) + '\n';
      rolesHistory.forEach((entry, idx) => {
        const parsed = typeof entry === 'string' ? safeParse(entry) : entry;
        let settingsData = null;
        if (parsed.type === 'roles') {
          // 新形式: data内にデータがある
          settingsData = parsed.data;
        } else if (parsed.settings) {
          // 旧形式: 直接settingsがある
          settingsData = parsed.settings;
        }

        if (settingsData) {
          rolesRound++;
          combinedContent += `\n${rolesRound}回目:\n`;
          const s = typeof settingsData === 'string' ? safeParse(settingsData) : settingsData;
          if (s && s.role_assignments && Array.isArray(s.role_assignments)) {
            combinedContent += s.role_assignments.map(r => `${r.name}: ${r.role}`).join('\n') + '\n';
          } else if (s && s.roles && typeof s.roles === 'string') {
            combinedContent += `役職: ${s.roles}\n`;
          } else if (s && s.assignments && Array.isArray(s.assignments)) {
            combinedContent += s.assignments.map(r => `${r.name}: ${r.role || ''}`).join('\n') + '\n';
          }
        }
      });
      combinedContent += '\n';
    }

    const filename = `${title.replace(/[\\/:*?"<>|]/g, '_')}_全履歴.txt`;
    downloadText(filename, combinedContent);
  });

  // Keyboard shortcuts for current tab
  document.addEventListener('keydown', function(e){
    const activePanel = document.querySelector('.bg-gray-100:not(.hidden)');
    if (!activePanel) return;

    let tab = null;
    if (activePanel.id === 'panel-groups') tab = 'groups';
    else if (activePanel.id === 'panel-order') tab = 'order';
    else if (activePanel.id === 'panel-roles') tab = 'roles';

    if (!tab) return;

    if(e.key === 'ArrowLeft') navigateHistory(tab, -1);
    if(e.key === 'ArrowRight') navigateHistory(tab, 1);
  });

  // Delete button confirmation
  const btnDelete = document.getElementById('btn-delete-event');
  if (btnDelete) {
    const deleteForm = btnDelete.closest('form');
    if (deleteForm) {
      deleteForm.addEventListener('submit', function(e) {
        const confirmed = window.confirm(<%= raw t("mypage.event_detail.delete_confirm_event").to_json %>);
        if (!confirmed) {
          e.preventDefault();
        }
      });
    }
  }

  // Toast notification function
  function showToast(message) {
    const toast = document.getElementById('toast');
    if (!toast) {
      // Create toast element if it doesn't exist
      const newToast = document.createElement('div');
      newToast.id = 'toast';
      newToast.className = 'fixed top-9 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50';
      newToast.style.top = '35px';
      document.body.appendChild(newToast);
      newToast.addEventListener('transitionend', function() {
        if (newToast.classList.contains('opacity-0')) {
          newToast.remove();
        }
      });
    }

    const toastEl = document.getElementById('toast');
    toastEl.textContent = message;
    toastEl.classList.remove('opacity-0');
    toastEl.style.zIndex = '1000';

    setTimeout(() => {
      toastEl.classList.add('opacity-0');
    }, 2000);
  }

  // SPA-style memo submission (XMLHttpRequestを使用してfetchオーバーライド問題を回避)
  const memoForm = document.getElementById('memo-form');
  if (memoForm) {
    memoForm.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopImmediatePropagation(); // Turboのイベントを完全に止める

      const formData = new FormData(memoForm);
      const url = memoForm.action;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

      // URLSearchParamsに変換
      const params = new URLSearchParams();
      for (let [key, value] of formData.entries()) {
        params.append(key, value);
      }

      // XMLHttpRequestを使用（fetchがオーバーライドされている問題を回避）
      const xhr = new XMLHttpRequest();
      xhr.open('PATCH', url, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('X-CSRF-Token', csrfToken);
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          showToast('メモを更新しました');
        } else {
          let errorMsg = '保存に失敗しました';
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.errors) errorMsg = data.errors.join(', ');
          } catch(e) {}
          alert('メモの保存に失敗しました: ' + errorMsg);
        }
      };

      xhr.onerror = function() {
        alert('メモの保存に失敗しました: 通信エラー');
      };

      xhr.send(params.toString());
    });
  }

  // イベントタイトルのインライン編集機能（マイページと同じスタイル）
  document.querySelectorAll('.event-title').forEach(titleSpan => {
    const startEdit = function(e) {
      e.preventDefault();
      const eventId = titleSpan.dataset.eventId;
      const oldTitle = titleSpan.dataset.eventTitle;

      // 既に入力フィールドがある場合は編集開始しない
      if (titleSpan.querySelector('input')) return;

      // 入力フィールドを作成
      const input = document.createElement('input');
      input.type = 'text';
      input.value = oldTitle;
      input.className = 'w-full px-2 py-1 text-2xl md:text-3xl font-bold text-gray-900 border-2 border-blue-500 rounded outline-none';
      input.setAttribute('autocomplete', 'off');

      // 既存の内容を置き換え
      while (titleSpan.firstChild) {
        titleSpan.removeChild(titleSpan.firstChild);
      }
      titleSpan.appendChild(input);
      input.focus();
      input.select();

      // キャンセル関数
      const cancelEdit = function(inputElement) {
        while (titleSpan.firstChild) {
          titleSpan.removeChild(titleSpan.firstChild);
        }
        titleSpan.textContent = oldTitle + ' ';
      };

      // 保存処理
      const saveEdit = function() {
        const newTitle = input.value.trim();

        // 変更がない場合はキャンセル
        if (newTitle === oldTitle) {
          cancelEdit(input);
          return;
        }

        // 空の場合はデフォルトタイトルを使用
        const finalTitle = newTitle || `イベント ${eventId}`;

        // 文字数制限チェック（255文字）
        if (finalTitle.length > 255) {
          alert('タイトルは255文字以内で入力してください');
          cancelEdit(input);
          return;
        }

        // サーバーに保存
        const formData = new FormData();
        formData.append('event[title]', finalTitle);

        fetch(`<%= event_path(@event) %>`, {
          method: 'PATCH',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/json'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 成功: タイトルを更新
            while (titleSpan.firstChild) {
              titleSpan.removeChild(titleSpan.firstChild);
            }
            titleSpan.textContent = finalTitle + ' ';
            titleSpan.dataset.eventTitle = finalTitle;

            // 更新日時を更新
            const timeElement = document.querySelector('img[alt="更新日アイコン"]').parentElement;
            if (timeElement) {
              const timeSpan = timeElement.querySelector('span');
              if (timeSpan) {
                const updatedText = timeSpan.textContent.split(': ')[0] + ': ' + new Date().toLocaleString('ja-JP', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                timeSpan.textContent = updatedText;
              }
            }

            showToast('タイトルを更新しました');
          } else {
            alert('保存に失敗しました: ' + (data.errors || '不明なエラー'));
            cancelEdit(input);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('保存に失敗しました: 通信エラー');
          cancelEdit(input);
        });
      };

      // イベントリスナー
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          input.blur(); // blurイベントで保存
        } else if (e.key === 'Escape') {
          input.removeEventListener('blur', saveEdit);
          cancelEdit(input);
        }
      });

      // クリックで編集開始
      titleSpan.addEventListener('click', startEdit);
    };

    // クリックで編集開始
    titleSpan.addEventListener('click', startEdit);
  });

})();
</script>
<% end %>
<%= yield :javascript %>
