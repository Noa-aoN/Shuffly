<%# app/views/events/new.html.erb %>
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6"><%= @event.title.presence || "イベント作成" %></h1>

  <div class="flex flex-col md:flex-row gap-6">

    <!-- 左カラム: 入力フォーム -->
    <div class="md:w-1/2 space-y-4">
      <div>
        <label class="block font-semibold mb-1">イベント名</label>
        <input type="text" id="eventTitle" value="<%= @event.title %>" class="border rounded-md px-3 py-2 w-full">
      </div>

      <div>
        <label class="block font-semibold mb-1">参加者（履歴付き）</label>
        <textarea id="membersInput" rows="10" class="border rounded-md px-3 py-2 w-full"><%= JSON.parse(@event.members_json || '[]').map { |m| m["name"] }.join("\n") %></textarea>
        <p class="text-sm text-gray-500 mt-1">例: Alice#1A#2B</p>
      </div>

      <div class="flex items-center gap-4">
        <div>
          <label class="block font-semibold mb-1">グループ数</label>
          <input type="number" id="groupCount" value="<%= @event.group_count.presence || 3 %>" min="1" max="26" class="border rounded-md px-2 py-1 w-20" oninput="updateGroupSizeHint()">
        </div>
        <span id="groupSizeHint" class="text-gray-600 mt-6"></span>
      </div>

      <div>
        <label class="block font-semibold mb-1">役割（任意）</label>
        <textarea id="rolesInput" rows="3" placeholder="リーダー, サブリーダー, ..." class="border rounded-md px-3 py-2 w-full"><%= @event.roles %></textarea>
        <div class="mt-1">
          <label class="inline-flex items-center space-x-2">
            <input type="checkbox" id="enableRoleShuffle" class="rounded border-gray-300">
            <span>ランダムに割り当て</span>
          </label>
        </div>
      </div>

      <div>
        <label class="inline-flex items-center space-x-2">
          <input type="checkbox" id="enableOrderShuffle" class="rounded border-gray-300">
          <span>メンバー順をランダムに</span>
        </label>
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button onclick="assignGroupsJSON()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">グループ分け実行</button>
        <button onclick="undoHistory()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md">⬅️ 戻る</button>
        <button onclick="redoHistory()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md">➡️ 進む</button>
      </div>

      <div class="mt-4">
        <%= button_to "イベント保存", @event.persisted? ? event_path(@event) : events_path, 
              method: @event.persisted? ? :patch : :post,
              class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md",
              form: { id: 'saveEventForm' },
              data: { turbo: false } %>
      </div>
    </div>

    <!-- 右カラム: 結果表示 -->
    <div class="md:w-1/2 space-y-4 relative z-0">
      <div>
        <h2 class="text-xl font-semibold mb-2">グループ表示</h2>
        <div class="flex items-center mb-2 gap-4">
          <label class="inline-flex items-center gap-1">
            <input type="checkbox" id="showGroupLabel" checked onchange="renderGroups()" class="rounded border-gray-300">
            <span>グループ名表示</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <span>セパレータ:</span>
            <select id="separatorSelect" onchange="renderGroups()" class="border rounded-md px-2 py-1">
              <option value=" ">スペース</option>
              <option value=",">カンマ</option>
              <option value="  ">ダブルスペース</option>
              <option value="\t">タブ</option>
            </select>
          </label>
          <button onclick="copyGroupOutput()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md">コピー</button>
        </div>
        <textarea id="groupOutput" rows="10" readonly class="border rounded-md px-3 py-2 w-full text-lg"></textarea>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">統計情報</h2>
        <textarea id="statsOutput" rows="10" readonly class="border rounded-md px-3 py-2 w-full text-lg"></textarea>
      </div>
    </div>

  </div>

  <!-- トースト -->
  <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded opacity-0 transition-opacity pointer-events-none"></div>
</div>

<script>
  // --- JSON対応版: SPAライクに整備 ---
  let history = [], currentHistoryIndex = -1;

  window.onload = () => {
    updateParticipantCount();
    pushToHistory();
    renderGroups();
    renderStats();
  };

  function parseEntry(entry) {
    const name = entry.split('#')[0];
    const hist = entry.match(/#\d+[A-Z]/g) || [];
    return {name, history: hist};
  }

  function getCurrentRound(entries){
    let max=0;
    for(const e of entries) for(const h of e.history) max=Math.max(max, parseInt(h.slice(1)));
    return max+1;
  }

  function getCoOccurrenceMap(entries, ignoreLast=true){
    const map={}, histories={};
    for(const e of entries) histories[e.name]=ignoreLast ? e.history.slice(0,-1) : e.history;
    for(const e of entries) map[e.name]={};
    for(const a of entries){
      for(const b of entries){
        if(a.name===b.name) continue;
        const overlap=histories[a.name].filter(h => histories[b.name].includes(h));
        map[a.name][b.name]=overlap.length;
      }
    }
    return map;
  }

  function assignGroupsJSON(){
    const raw=document.getElementById("membersInput").value.trim().split(/\r?\n/).filter(Boolean);
    let entries=raw.map(parseEntry);
    const round=getCurrentRound(entries);
    const groupCount=Math.min(parseInt(document.getElementById("groupCount").value),26);
    const groupNames=Array.from({length:groupCount},(_,i)=>String.fromCharCode(65+i));
    const groups=Object.fromEntries(groupNames.map(g=>[g,[]]));
    const coMap=getCoOccurrenceMap(entries);
    entries=entries.sort(()=>Math.random()-0.5);

    for(const p of entries){
      const empty=groupNames.find(g=>groups[g].length===0);
      if(empty){groups[empty].push(p); continue;}
      const minSize=Math.min(...groupNames.map(g=>groups[g].length));
      const candidates=groupNames.filter(g=>groups[g].length===minSize);
      let minMK=Infinity, selected=candidates[0];
      for(const g of candidates){
        const mk=groups[g].reduce((acc,q)=>acc+(coMap[p.name][q.name]||0),0);
        if(mk<minMK){minMK=mk; selected=g;}
      }
      groups[selected].push(p);
    }

    // JSON文字列に変換して membersInput に戻す
    const updated=groupNames.flatMap(g=>groups[g].map(e=>`${e.name}${e.history.join('')}#${round}${g}`));
    document.getElementById("membersInput").value=updated.join("\n");

    updateParticipantCount();
    renderGroups();
    renderStats();
    pushToHistory();
  }

  function renderGroups(){
    const raw=document.getElementById("membersInput").value.trim().split(/\r?\n/).filter(Boolean);
    const entries=raw.map(parseEntry);
    const groupCount=parseInt(document.getElementById("groupCount").value);
    if(!groupCount||groupCount<1) return;
    const groupNames=Array.from({length:groupCount},(_,i)=>String.fromCharCode(65+i));
    const groups=Object.fromEntries(groupNames.map(g=>[g,[]]));
    for(const e of entries){
      const last=e.history.at(-1);
      let g=last?.match(/[A-Z]$/)?.[0]||groupNames[0];
      if(!groupNames.includes(g)) g=groupNames[0];
      groups[g].push(e.name);
    }

    const sep=document.getElementById("separatorSelect").value;
    const showLabel=document.getElementById("showGroupLabel").checked;
    let display='';
    for(const g of groupNames){
      const members=groups[g];
      if(showLabel) display+=`${g} (${members.length}名):\n`;
      display+=members.join(sep)+'\n\n';
    }
    document.getElementById("groupOutput").value=display.trim();
  }

  function renderStats(){
    const raw=document.getElementById("membersInput").value.trim().split(/\r?\n/).filter(Boolean);
    const entries=raw.map(parseEntry);
    const coMap=getCoOccurrenceMap(entries,true);
    const groupCount=parseInt(document.getElementById("groupCount").value);
    const groupNames=Array.from({length:groupCount},(_,i)=>String.fromCharCode(65+i));
    const groupMap=Object.fromEntries(groupNames.map(g=>[g,[]]));
    for(const e of entries){
      const last=e.history.at(-1)?.match(/[A-Z]$/);
      let g=last?.[0]||groupNames[0];
      if(!groupNames.includes(g)) g=groupNames[0];
      groupMap[g].push(e.name);
    }
    const lines=[];
    for(const g of groupNames){
      const members=groupMap[g];
      let total=0;
      for(const m of members){
        const mk=members.reduce((sum,other)=>sum+(m!==other?(coMap[m][other]||0):0),0);
        lines.push(`${m}: MK=${mk}`);
        total+=mk;
      }
      lines.push(`Group ${g}: MA=${members.length? (total/members.length).toFixed(2):0}`);
      lines.push('');
    }
    document.getElementById("statsOutput").value=lines.join("\n");
  }

  function updateParticipantCount(){
    const count=document.getElementById("membersInput").value.trim().split(/\r?\n/).filter(Boolean).length;
    const span=document.getElementById("groupSizeHint");
    const groupCount=parseInt(document.getElementById("groupCount").value);
    if(!groupCount||groupCount<1){span.textContent=''; return;}
    const min=Math.floor(count/groupCount), max=Math.ceil(count/groupCount);
    span.textContent=min===max?`（1グループあたり${min}人）`:`（1グループあたり${min}〜${max}人）`;
  }

  function copyGroupOutput(){
    const textarea=document.getElementById("groupOutput");
    navigator.clipboard.writeText(textarea.value).then(()=>showToast("コピーしました！")).catch(()=>showToast("コピーに失敗"));
  }

  function showToast(msg){
    const toast=document.getElementById("toast");
    toast.textContent=msg;
    toast.classList.remove("opacity-0");
    setTimeout(()=>toast.classList.add("opacity-0"),1200);
  }

  function pushToHistory(){
    const text=document.getElementById("membersInput").value;
    if(history[currentHistoryIndex]===text) return;
    history=history.slice(0,currentHistoryIndex+1);
    history.push(text);
    currentHistoryIndex++;
  }

  function undoHistory(){
    if(currentHistoryIndex>0){
      currentHistoryIndex--;
      document.getElementById("membersInput").value=history[currentHistoryIndex];
      updateParticipantCount(); renderGroups(); renderStats(); showToast("1ステップ戻しました");
    }else showToast("これ以上戻れません");
  }

  function redoHistory(){
    if(currentHistoryIndex<history.length-1){
      currentHistoryIndex++;
      document.getElementById("membersInput").value=history[currentHistoryIndex];
      updateParticipantCount(); renderGroups(); renderStats(); showToast("1ステップ進めました");
    }else showToast("これ以上進めません");
  }

  document.getElementById('membersInput').addEventListener('input', ()=>{ updateParticipantCount(); pushToHistory(); renderGroups(); renderStats(); });
  document.getElementById('groupCount').addEventListener('input', ()=>{ updateParticipantCount(); renderGroups(); renderStats(); });
</script>