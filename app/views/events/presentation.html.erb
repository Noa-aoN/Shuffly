<%# filepath: /Users/n/workspace/Shuffly/app/views/events/presentation.html.erb %>
<div class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto px-6 py-12">
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div>
            <h1 class="text-4xl font-extrabold">プレゼンテーションモード</h1>
            <p class="text-sm text-gray-600 mt-1">準備が完了したら、下のボタンで結果を表示します</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="btn-back-to-settings" class="px-4 py-2 bg-white border border-gray-200 rounded text-sm shadow-sm">イベント設定に戻る</button>
          <button id="btn-close" class="px-3 py-2 text-sm text-gray-600">閉じる</button>
        </div>
      </div>

      <!-- tabs (centered) -->
      <nav class="mt-6 border-b border-gray-200">
        <div class="flex gap-8 text-sm justify-center w-full">
          <button data-mode="groups" class="mode-btn pb-3 text-blue-600 border-b-2 border-blue-600">グループ分け</button>
          <button data-mode="order" class="mode-btn pb-3 text-gray-600 hover:text-gray-800">順番決め</button>
          <button data-mode="roles" class="mode-btn pb-3 text-gray-600 hover:text-gray-800">役割決め</button>
        </div>
      </nav>
    </header>

    <main>
      <div id="pres-content" class="grid grid-cols-1 gap-6">
        <!-- large visible area (white rounded dashed box) -->
        <section class="bg-white rounded-lg border-2 border-dashed border-gray-300 p-10 flex flex-col items-center justify-center min-h-[360px]">
          <div class="text-center max-w-3xl w-full">
            <h2 id="display-subtitle" class="text-xl font-semibold mb-2">シャッフル結果</h2>
            <p id="display-hint" class="text-sm text-gray-500">結果はここに表示されます。「次へ」または「一括表示」ボタンをクリックして開始してください。</p>

            <div id="display-area" class="mt-8 w-full bg-white">
              <!-- large display used by script — initially empty until reveal -->
              <div id="display-item" class="text-4xl md:text-5xl font-extrabold text-center leading-relaxed whitespace-pre-wrap"></div>
            </div>

            <!-- small snapshot (kept hidden by default so nothing shows until reveal) -->
            <div id="pres-snapshot" class="mt-8 text-sm text-gray-600 whitespace-pre-wrap hidden"></div>
          </div>
        </section>

        <!-- controls centered under the big box -->
        <div class="flex justify-center gap-4 mt-4">
          <button id="btn-prev-item" class="px-6 py-3 bg-white border rounded shadow-sm text-gray-700">前へ</button>
          <button id="btn-next-item" class="px-6 py-3 bg-white border rounded shadow-sm text-gray-700">次へ</button>
          <button id="btn-reveal" class="px-6 py-3 bg-blue-600 text-white rounded shadow">一括表示</button>
        </div>

        <!-- hidden controls / compact list for presenter (kept for functionality) -->
        <div class="hidden md:flex items-start gap-6 mt-6">
          <div class="flex items-center gap-2">
            <button id="btn-prev-snapshot" class="px-3 py-1 bg-white border rounded disabled:opacity-50">履歴◀</button>
            <button id="btn-next-snapshot" class="px-3 py-1 bg-white border rounded disabled:opacity-50">履歴▶</button>
            <span id="snapshot-index" class="ml-3 text-sm text-gray-500"></span>
          </div>

          <div class="ml-auto text-sm text-gray-500">
            <span id="display-counter"></span>
          </div>
        </div>

        <!-- compact list for quick selection (kept but visually subtle) -->
        <div id="list-compact" class="hidden md:block text-sm text-gray-700"></div>
      </div>
    </main>
  </div>
</div>

<script>
(function(){
  function safeParse(v){
    if(!v) return null;
    if(typeof v === 'object') return v;
    try { return JSON.parse(v); } catch(e) {
      try { return JSON.parse(decodeURIComponent(v)); } catch(e){ return null; }
    }
  }
  function getParam(name){
    try{ const params = new URLSearchParams(window.location.search); return params.has(name) ? params.get(name) : null; }catch(e){ return null; }
  }

  // load payload (query first, then localStorage)
  let payload = null;
  try {
    const members_raw = getParam('members_json') || getParam('membersJson') || null;
    const results_raw = getParam('results_json') || getParam('resultsJson') || null;
    const order_raw = getParam('order_json') || getParam('orderJson') || null;
    const settings_raw = getParam('settings_json') || getParam('settingsJson') || null;
    const history_raw = getParam('history_json') || getParam('historyJson') || null;
    const title_raw = (new URLSearchParams(window.location.search)).get('title') || null;

    if(members_raw || results_raw || order_raw || settings_raw || history_raw || title_raw){
      payload = {
        members_json: safeParse(members_raw),
        results_json: safeParse(results_raw),
        order_json: safeParse(order_raw),
        settings_json: safeParse(settings_raw),
        history_json: safeParse(history_raw),
        title: title_raw || ''
      };
    }
  } catch(e){ payload = null; }

  if(!payload){
    try {
      const raw = localStorage.getItem('presentation_shuffly_event') || localStorage.getItem('pending_shuffly_event');
      if(raw){
        const p = safeParse(raw) || JSON.parse(raw);
        payload = {
          members_json: safeParse(p.members_json) || p.members_json || null,
          results_json: safeParse(p.results_json) || p.results_json || null,
          order_json: safeParse(p.order_json) || p.order_json || null,
          settings_json: safeParse(p.settings_json) || p.settings_json || null,
          history_json: safeParse(p.history_json) || p.history_json || null,
          title: p.title || ''
        };
      }
    } catch(e){ /* ignore */ }
  }

  if(!payload) payload = { members_json:null, results_json:null, order_json:null, settings_json:null, history_json:null, title:'' };

  // DOM refs
  const titleEl = document.querySelector('h1') || document.getElementById('pres-title');
  const displaySubtitle = document.getElementById('display-subtitle');
  const displayItem = document.getElementById('display-item');
  const displayCounter = document.getElementById('display-counter');
  const presSnapshot = document.getElementById('pres-snapshot');
  const listCompact = document.getElementById('list-compact');
  const snapshotIndexEl = document.getElementById('snapshot-index');
  const prevSnapshotBtn = document.getElementById('btn-prev-snapshot');
  const nextSnapshotBtn = document.getElementById('btn-next-snapshot');

  if(titleEl) titleEl.textContent = payload.title || document.title || 'プレゼンテーション';

  // prepare data structures for modes
  function normalizeGroups(results){
    if(!results) return [];
    if(results.groups && typeof results.groups === 'object'){
      const names = results.group_names || results.groupNames || {};
      const keys = Object.keys(results.groups);
      return keys.map(k => ({ label: names[k] || k, members: Array.isArray(results.groups[k]) ? results.groups[k] : [] }));
    }
    if(Array.isArray(results)){
      return results.map((g,i) => {
        if(typeof g === 'string') return { label: `Group ${i+1}`, members: [g] };
        if(Array.isArray(g)) return { label: `Group ${i+1}`, members: g };
        if(g && (g.name || g.label)) return { label: g.name || g.label, members: g.members || [] };
        return { label: `Group ${i+1}`, members: [] };
      });
    }
    return [];
  }

  const rawResults = payload.results_json;
  const groupsList = normalizeGroups(rawResults);
  const orderList = (() => {
    const o = payload.order_json || payload.orderJson || [];
    if(Array.isArray(o)) return o.map((it,i) => (typeof it === 'string' ? { name: it } : it));
    return [];
  })();
  const rolesList = (() => {
    const s = payload.settings_json || payload.settingsJson || {};
    if(s && Array.isArray(s.role_assignments)) return s.role_assignments.map(r => ({ name: r.name, role: r.role }));
    if(s && s.roles && typeof s.roles === 'object') return Object.keys(s.roles).map(k => ({ name: k, role: s.roles[k] }));
    return [];
  })();

  // snapshot/history handling (kept but not shown until reveal)
  let history = [];
  if(Array.isArray(payload.history_json)) history = payload.history_json.slice();
  else if(typeof payload.history_json === 'string'){
    const parsed = safeParse(payload.history_json);
    if(Array.isArray(parsed)) history = parsed;
  }
  if(history.length === 0 && payload.members_json && Array.isArray(payload.members_json)){
    history = [ payload.members_json ];
  }
  let historyIdx = history.length > 0 ? history.length - 1 : -1;
  function updateSnapshotUI(){
    if(historyIdx < 0 || history.length === 0){
      presSnapshot.textContent = '';
      snapshotIndexEl.textContent = '';
      if(prevSnapshotBtn) prevSnapshotBtn.disabled = true;
      if(nextSnapshotBtn) nextSnapshotBtn.disabled = true;
    } else {
      const raw = history[historyIdx];
      const parsed = safeParse(raw) || raw;
      presSnapshot.textContent = typeof parsed === 'string' ? parsed : JSON.stringify(parsed, null, 2);
      snapshotIndexEl.textContent = ` ${historyIdx+1}/${history.length}`;
      if(prevSnapshotBtn) prevSnapshotBtn.disabled = historyIdx <= 0;
      if(nextSnapshotBtn) nextSnapshotBtn.disabled = historyIdx >= history.length - 1;
    }
  }
  if(prevSnapshotBtn) prevSnapshotBtn.addEventListener('click', ()=>{ if(historyIdx>0){ historyIdx--; updateSnapshotUI(); }});
  if(nextSnapshotBtn) nextSnapshotBtn.addEventListener('click', ()=>{ if(historyIdx < history.length-1){ historyIdx++; updateSnapshotUI(); }});
  updateSnapshotUI();

  // mode state and per-mode index
  let mode = 'groups'; // groups | order | roles
  const modeBtns = Array.from(document.querySelectorAll('.mode-btn'));
  const indices = { groups: 0, order: 0, roles: 0 };
  const counts = { groups: groupsList.length, order: orderList.length, roles: rolesList.length };

  function setMode(m){
    mode = m;
    modeBtns.forEach(b => {
      b.classList.toggle('text-blue-600', b.dataset.mode === m);
      b.classList.toggle('border-b-2', b.dataset.mode === m);
      b.classList.toggle('border-blue-600', b.dataset.mode === m);
      b.classList.toggle('text-gray-600', b.dataset.mode !== m);
    });
    if(m === 'groups') displaySubtitle.textContent = 'シャッフル結果';
    if(m === 'order') displaySubtitle.textContent = '順番（1件ずつ表示）';
    if(m === 'roles') displaySubtitle.textContent = '役職（1件ずつ表示）';
    rebuildListCompact();
    updateDisplay(); // do not auto-reveal; updateDisplay keeps content empty until reveal
  }
  modeBtns.forEach(b => b.addEventListener('click', ()=> setMode(b.dataset.mode)));

  function rebuildListCompact(){
    if(!listCompact) return;
    listCompact.innerHTML = '';
    if(mode === 'groups'){
      groupsList.forEach((g,i) => {
        const el = document.createElement('div');
        el.className = 'p-2 bg-white rounded cursor-pointer hover:bg-gray-50';
        el.textContent = `${i+1}. ${g.label} (${g.members.length})`;
        el.addEventListener('click', () => { indices.groups = i; revealCurrent(); });
        listCompact.appendChild(el);
      });
      if(groupsList.length === 0) listCompact.textContent = '';
    } else if(mode === 'order'){
      orderList.forEach((o,i) => {
        const el = document.createElement('div');
        el.className = 'p-2 bg-white rounded cursor-pointer hover:bg-gray-50';
        el.textContent = `${i+1}. ${o.name || JSON.stringify(o)}`;
        el.addEventListener('click', () => { indices.order = i; revealCurrent(); });
        listCompact.appendChild(el);
      });
      if(orderList.length === 0) listCompact.textContent = '';
    } else if(mode === 'roles'){
      rolesList.forEach((r,i) => {
        const el = document.createElement('div');
        el.className = 'p-2 bg-white rounded cursor-pointer hover:bg-gray-50';
        el.textContent = `${i+1}. ${r.name || ''} ${r.role ? '– ' + r.role : ''}`;
        el.addEventListener('click', () => { indices.roles = i; revealCurrent(); });
        listCompact.appendChild(el);
      });
      if(rolesList.length === 0) listCompact.textContent = '';
    }
    counts.groups = groupsList.length; counts.order = orderList.length; counts.roles = rolesList.length;
  }

  // display control
  let revealed = false;
  const btnReveal = document.getElementById('btn-reveal');
  const btnPrevItem = document.getElementById('btn-prev-item');
  const btnNextItem = document.getElementById('btn-next-item');

  function updateControls(){
    const len = counts[mode] || 0;
    const idx = indices[mode] || 0;
    if(btnPrevItem) btnPrevItem.disabled = !revealed || idx <= 0;
    if(btnNextItem) btnNextItem.disabled = !revealed || idx >= len - 1;
    if(displayCounter) displayCounter.textContent = revealed && len > 0 ? `${idx+1}/${len}` : '';
    if(btnReveal) btnReveal.classList.toggle('hidden', revealed);
  }

  function formatGroupForDisplay(g){
    const members = Array.isArray(g.members) ? g.members : [];
    const header = (g.label && g.label !== '') ? `${g.label}（${members.length}名）` : `（${members.length}名）`;
    const lines = [header, ''];
    members.forEach(m => {
      if(typeof m === 'string') lines.push(m);
      else if(m && (m.name || m.full_name)) lines.push(m.name || m.full_name);
      else lines.push(JSON.stringify(m));
    });
    return lines.join('\n');
  }

  function formatOrderForDisplay(o){
    if(!o) return '';
    if(typeof o === 'string') return o;
    if(o.name) return o.name;
    return JSON.stringify(o);
  }

  function formatRoleForDisplay(r){
    if(!r) return '';
    return (r.name || '') + (r.role ? ` — ${r.role}` : '');
  }

  function updateDisplay(){
    const len = counts[mode] || 0;
    const idx = indices[mode] || 0;
    if(!revealed){
      displayItem.textContent = ''; // ensure nothing shown until reveal
    } else {
      if(mode === 'groups'){
        if(len === 0){ displayItem.textContent = ''; }
        else displayItem.textContent = formatGroupForDisplay(groupsList[idx]);
      } else if(mode === 'order'){
        if(len === 0){ displayItem.textContent = ''; }
        else displayItem.textContent = formatOrderForDisplay(orderList[idx]);
      } else if(mode === 'roles'){
        if(len === 0){ displayItem.textContent = ''; }
        else displayItem.textContent = formatRoleForDisplay(rolesList[idx]);
      }
    }
    updateControls();
  }

  function revealCurrent(){
    revealed = true;
    // show snapshot (if exists) for presenter; otherwise keep it hidden
    if(presSnapshot && presSnapshot.textContent) presSnapshot.classList.remove('hidden');
    updateDisplay();
  }
  function hideAll(){
    revealed = false;
    displayItem.textContent = '';
    updateControls();
  }

  if(btnReveal) btnReveal.addEventListener('click', () => revealCurrent());
  if(btnPrevItem) btnPrevItem.addEventListener('click', () => {
    if(indices[mode] > 0){ indices[mode]--; revealCurrent(); }
  });
  if(btnNextItem) btnNextItem.addEventListener('click', () => {
    if(indices[mode] < (counts[mode]-1)){ indices[mode]++; revealCurrent(); }
  });

  // init (do not reveal anything on load)
  setMode('groups');
  rebuildListCompact();
  updateDisplay();

  // back -> restore pending inputs and go to new
  document.getElementById('btn-back-to-settings').addEventListener('click', function(){
    try{
      const preview = {
        members_json: (typeof payload.members_json === 'string') ? payload.members_json : (payload.members_json ? JSON.stringify(payload.members_json) : ''),
        results_json: (typeof payload.results_json === 'string') ? payload.results_json : (payload.results_json ? JSON.stringify(payload.results_json) : ''),
        order_json: (typeof payload.order_json === 'string') ? payload.order_json : (payload.order_json ? JSON.stringify(payload.order_json) : ''),
        settings_json: (typeof payload.settings_json === 'string') ? payload.settings_json : (payload.settings_json ? JSON.stringify(payload.settings_json) : ''),
        history_json: (typeof payload.history_json === 'string') ? payload.history_json : (payload.history_json ? JSON.stringify(payload.history_json) : ''),
        title: payload.title || ''
      };
      localStorage.setItem('pending_shuffly_event', JSON.stringify(preview));
    }catch(e){}
    window.location.href = "<%= new_event_path %>";
  });

  document.getElementById('btn-close').addEventListener('click', function(){
    if(window.opener) window.close(); else window.location.href = "<%= root_path %>";
  });

  // keyboard
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape') document.getElementById('btn-back-to-settings').click();
    if(e.key === 'ArrowLeft') document.getElementById('btn-prev-item').click();
    if(e.key === 'ArrowRight') document.getElementById('btn-next-item').click();
    if(e.key === ' '){ e.preventDefault(); revealed ? hideAll() : revealCurrent(); }
  });

})();
</script>
