<%# メンバーリストフォームパーシャル %>

<div class="bg-white rounded-xl shadow-sm p-6">
  <%= form_with(model: member_list, local: true, class: "space-y-6") do |f| %>
    <%= render "shared/error_messages", resource: member_list %>

    <%# メンバーリスト名 %>
    <div>
      <%= f.label :name, class: "block text-sm font-medium text-gray-700" do %>
        <%= t("member_lists.form.name_label") %>
        <span class="text-red-500 ml-1">*</span>
      <% end %>
      <%= f.text_field :name,
            class: "mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition",
            placeholder: t("member_lists.form.name_placeholder") %>
    </div>

    <%# メンバー一覧 %>
    <div>
      <%= f.label :members_text, t("member_lists.form.members_label"), class: "block text-sm font-medium text-gray-700" %>
      <p class="text-xs text-gray-500 mb-2"><%= t("member_lists.form.members_hint") %></p>
      <%= f.text_area :members_text,
            rows: 10,
            class: "w-full border border-gray-300 rounded-lg px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition font-mono text-sm",
            placeholder: t("member_lists.form.members_placeholder"),
            id: "members-input" %>

      <%# 補助ボタン %>
      <div class="mt-2 flex flex-wrap gap-2">
        <%= render 'shared/button',
              button_text: t("member_lists.form.sample_button"),
              path: '#',
              variant: 'tertiary',
              size: 'sm',
              extra_class: 'sm:min-w-0',
              id: 'btn-sample-members',
              data_action: 'click->members-input#sample' %>
        <%= render 'shared/button',
              button_text: t("member_lists.form.clear_button"),
              path: '#',
              variant: 'tertiary',
              size: 'sm',
              extra_class: 'sm:min-w-0',
              id: 'btn-clear-members',
              data_action: 'click->members-input#clear' %>
        <%= render 'shared/button',
              button_text: t("member_lists.form.count_button"),
              path: '#',
              variant: 'secondary',
              size: 'sm',
              extra_class: 'sm:min-w-0',
              id: 'btn-count-members',
              data_action: 'click->members-input#count' %>
      </div>
      <p id="members-count" class="text-sm text-gray-600 mt-2"></p>
    </div>

    <%# アクションボタン %>
    <div class="flex justify-center gap-4 pt-4">
      <%= render 'shared/button',
            f: f,
            button_text: t("member_lists.form.submit"),
            variant: 'primary',
            size: 'lg' %>
      <%= render 'shared/button',
            button_text: t("member_lists.form.cancel"),
            path: mypage_path(tab: 'member_lists'),
            variant: 'secondary',
            size: 'lg' %>
    </div>

    <%# 削除ボタン（編集時のみ表示） %>
    <% if member_list.persisted? %>
      <div class="pt-6 border-t border-gray-200">
        <div class="flex justify-center">
          <%= render 'shared/button',
                button_text: t("member_lists.edit.delete"),
                path: member_list_path(member_list),
                variant: 'danger',
                size: 'md',
                button_to_method: :delete,
                confirm_message: t("member_lists.edit.delete_confirm") %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
(function(){
  const membersInput = document.getElementById('members-input');
  const countDisplay = document.getElementById('members-count');

  if (!membersInput || !countDisplay) return;

  function updateCount() {
    const text = membersInput.value.trim();
    if (!text) {
      countDisplay.textContent = '';
      return;
    }
    const members = text.split('\n').filter(m => m.trim());
    countDisplay.textContent = <%= raw t("member_lists.form.members_count", count: "__COUNT__").to_json %>.replace("__COUNT__", members.length);
  }

  function parseMembers() {
    const text = membersInput.value.trim();
    if (!text) return [];
    return text.split('\n').filter(m => m.trim()).map(m => m.trim());
  }

  function formatMembers(members) {
    return members.join('\n');
  }

  // Sample members
  const btnSample = document.getElementById('btn-sample-members');
  if (btnSample) {
    btnSample.addEventListener('click', function(e){
      e.preventDefault();
      const sample = [
        "田中 太郎",
        "山田 花子",
        "佐藤 次郎",
        "鈴木 三郎",
        "高橋 四郎",
        "伊藤 五郎",
        "渡辺 六郎",
        "中村 七郎",
        "小林 八郎",
        "加藤 九郎"
      ];
      membersInput.value = formatMembers(sample);
      updateCount();
    });
  }

  // Clear members
  const btnClear = document.getElementById('btn-clear-members');
  if (btnClear) {
    btnClear.addEventListener('click', function(e){
      e.preventDefault();
      membersInput.value = '';
      updateCount();
    });
  }

  // Count members
  const btnCount = document.getElementById('btn-count-members');
  if (btnCount) {
    btnCount.addEventListener('click', function(e){
      e.preventDefault();
      const members = parseMembers();
      alert(<%= raw t("member_lists.form.count_alert", count: "__COUNT__").to_json %>.replace("__COUNT__", members.length));
    });
  }

  // Update count on input
  membersInput.addEventListener('input', updateCount);

  // Initial count
  updateCount();
})();
</script>
